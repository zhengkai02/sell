<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.iwhalecloud.retail.offer.mapper.EvaluationMapper">

    <select id="countListByObjTypeAndObjId" resultType="java.lang.Integer">
        select count(*)
          from tbl_evaluation
         where state = 'A'
           and obj_type = #{objType}
           and obj_id = #{objId}
    </select>

    <select id="countListByObjTypeAndObjIdAndTime" resultType="java.lang.Integer">
        select count(*)
          from tbl_evaluation
         where state = 'A'
           and obj_type = #{objType}
           and obj_id = #{objId}
           and create_time between #{preTime} and #{time}
    </select>

    <select id="countRateIsFiveListByObjTypeAndObjId" resultType="java.lang.Integer">
        select count(*)
          from tbl_evaluation
         where state = 'A'
           and rate = 5
           and obj_id = #{objId}
           and obj_type = #{objType}
    </select>

    <select id="sumRateByObjTypeAndObjId" resultType="java.lang.Integer">
        select sum(rate)
          from tbl_evaluation
         where state = 'A'
           and obj_id = #{objId}
           and obj_type = #{objType}
    </select>

    <select id="sumRateByObjTypeAndObjIdAndTime" resultType="java.lang.Integer">
        select sum(rate)
          from tbl_evaluation
         where state = 'A'
           and obj_id = #{objId}
           and obj_type = #{objType}
           and create_time between #{preTime} and #{time}
    </select>

    <update id="updateUsefulCountById">
        update tbl_evaluation
           set useful_count = #{usefulCount}
         where evaluation_id = #{evaluationId}
    </update>


    <update id="updateUselessCountById">
        update tbl_evaluation
           set useless_count = #{uselessCount}
         where evaluation_id = #{evaluationId}
    </update>

    <select id="qryEvaluation" resultType="com.iwhalecloud.retail.offer.dto.resp.EvaluationResp">
        select e.evaluation_Id, e.nickname, e.phone, e.evaluation_comments, DATE_FORMAT(e.create_time,'%Y-%m-%d %H:%i:%s') as create_time, e.rate,
               e.state, e.useful_count, e.useless_count, e.obj_type, e.obj_id, e.user_id, p.name as obj_name, e.tenant_id
          from tbl_evaluation e
     left join tbl_prod_goods p ON e.obj_id = p.goods_id
         where 1 = 1
        <if test="req.objType != null and req.objType != ''">
            and e.obj_type = #{req.objType}
        </if>
        <if test="req.objId != null and req.objId != ''">
            and e.obj_id = #{req.objId}
        </if>
        <if test="req.rate != null and req.rate != ''">
            and e.rate = #{req.rate}
        </if>
        <if test="req.storeId != null and req.storeId != ''">
            and e.store_id = #{req.storeId}
        </if>
        <if test="req.beginTime != null" >
            and e.create_time &gt;= #{req.beginTime}
        </if>
        <if test="req.endTime != null">
            and e.create_time &lt;= #{req.endTime}
        </if>
        <if test="req.comments != null and req.comments != ''">
            and lower(evaluation_comments) like lower(concat(concat('%', #{req.comments}), '%'))
        </if>
        <if test="req.tenantId != null">
            and e.tenant_id = #{req.tenantId}
        </if>
        <choose>
            <when test="req.state != null and req.state != ''">
                and e.state = #{req.state}
            </when>
            <otherwise>
                and e.state = 'A'
            </otherwise>
        </choose>
        order by e.create_time desc
    </select>

    <select id="qryProdGoodsEvaluation" resultType="com.iwhalecloud.retail.offer.dto.resp.ProdGoodsEvaluationQryResp">
        select e.evaluation_Id, e.nickname, e.phone, e.evaluation_comments, DATE_FORMAT(e.create_time,'%Y-%m-%d %h:%m:%s') as create_time, e.rate,
        e.state, p.name, s.store_name
        from tbl_evaluation e
        left join tbl_prod_goods p on e.obj_id = p.goods_id
        left join tbl_store s on s.store_id = e.store_id
        where e.obj_type = 'A' and e.state != 'X'
        <if test="req.rate != null and req.rate != ''">
            and e.rate = #{req.rate}
        </if>
        <if test="req.storeId != null and req.storeId != ''">
            and e.store_id = #{req.storeId}
        </if>
        <if test="req.beginTime != null" >
            and e.create_time &gt;= #{req.beginTime}
        </if>
        <if test="req.endTime != null">
            and e.create_time &lt;= #{req.endTime}
        </if>
        <if test="req.name != null and req.name != ''">
            and lower(name) like lower(concat(concat('%', #{req.name}), '%'))
        </if>
    </select>

    <select id="qryContentEvaluation" resultType="com.iwhalecloud.retail.offer.dto.resp.ContentEvaluationQryResp">
        select e.evaluation_Id, e.obj_id, e.nickname, e.phone, e.evaluation_comments, DATE_FORMAT(e.create_time,'%Y-%m-%d %h:%m:%s') as create_time, e.rate,
        e.state
        from tbl_evaluation e
        where e.obj_type = 'B' and e.state != 'X'
        <if test="req.state != null and req.state != ''">
            and e.state = #{req.state}
        </if>
        <if test="req.nickname != null and req.nickname != ''">
            and lower(e.nickname) like lower(concat(concat('%', #{req.nickname}), '%'))
        </if>
        <if test="req.beginTime != null" >
            and e.create_time &gt;= #{req.beginTime}
        </if>
        <if test="req.endTime != null">
            and e.create_time &lt;= #{req.endTime}
        </if>
        <if test="req.objIds != null and req.objIds.size() > 0">
            and e.obj_id in
            <foreach collection="req.objIds" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        order by e.create_time desc
    </select>

    <select id="qryEvaluationByObjAndUserId" resultType="com.iwhalecloud.retail.offer.dto.resp.EvaluationResp">
        select *
          from tbl_evaluation
         where state != 'X'
           and obj_type = #{req.objType}
           and obj_id = #{req.objId}
           and user_id = #{req.userId}
    </select>

    <update id="batchDelEvaluation">
        update tbl_evaluation
        set state = 'X',
        modify_time = now(),
        modify_by = #{modifyBy}
        where 1 = 1
        and evaluation_id in
        <foreach collection="ids" item="evaluationId" index="index" open="(" close=")" separator=",">
            #{evaluationId}
        </foreach>

    </update>

    <update id="batchHide">
        update tbl_evaluation
        set state = 'B',
        modify_time = now(),
        modify_by = #{modifyBy}
        where 1 = 1
        and evaluation_id in
        <foreach collection="ids" item="evaluationId" index="index" open="(" close=")" separator=",">
            #{evaluationId}
        </foreach>
    </update>

    <update id="batchDisplay">
        update tbl_evaluation
        set state = 'A',
        modify_time = now(),
        modify_by = #{modifyBy}
        where 1 = 1
        and evaluation_id in
        <foreach collection="ids" item="evaluationId" index="index" open="(" close=")" separator=",">
            #{evaluationId}
        </foreach>

    </update>

    <update id="modEvaluation">
        update tbl_evaluation
        <set>
            <if test="req.evaluationComments!= null and req.evaluationComments != ''">evaluation_comments=#{req.evaluationComments},</if>
            <if test="req.rate != null and req.rate != ''">rate = #{req.rate},</if>
            <if test="req.state != null and req.state != ''">state = #{req.state},</if>
            <if test="req.modifyBy != null and req.modifyBy != ''">modify_by = #{req.modifyBy}</if>
            modify_time = now()
        </set>
        where 1 = 1
        and evaluation_id = #{req.evaluationId}
    </update>

    <update id="batchAudit">
        update tbl_evaluation
           set state = #{req.state}, modify_time = now(), modify_by = #{req.modifyBy}
         where evaluation_id in
        <foreach collection="req.ids" item="evaluationId" index="index" open="(" close=")" separator=",">
               #{evaluationId}
        </foreach>
    </update>

    <select id="sumRateByStoreId" resultType="java.lang.Long">
        select sum(
               case rate
               when 5 then 1
               when 3 then 0
               when 1 then -1 end
               ) rate
          from tbl_evaluation
         where state = 'A'
           and store_id = #{storeId}
    </select>

    <select id="countEvaluationByUserIdAndStoreId" resultType="java.lang.Long">
        select count(1)
          from tbl_evaluation
         where state = 'A'
           and store_id = #{storeId}
           and user_id = #{userId}
           and create_time between #{preTime} and #{time}
    </select>

</mapper>