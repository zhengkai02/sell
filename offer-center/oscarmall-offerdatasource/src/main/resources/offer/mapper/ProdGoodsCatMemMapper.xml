<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.iwhalecloud.retail.offer.mapper.ProdGoodsCatMemMapper">

    <sql id="prod_goods_cat_mem_column">
        a.cat_mem_id,a.cat_id,a.goods_id
    </sql>

    <select id="selectProdGoodsCatMemByCat" resultType="com.iwhalecloud.retail.offer.entity.ProdGoodsCatMem">
        select
        <include refid="prod_goods_cat_mem_column"/>
        from tbl_prod_goods_cat_mem a
        join tbl_prod_goods p on p.goods_id = a.goods_id
       where p.state != 'X'
         and a.state = 'A'
         and a.cat_id = #{catId}
        order by a.goods_id
    </select>

    <select id="qryProdGoodsCatMemDetailByCatId" resultType="com.iwhalecloud.retail.offer.dto.resp.QryGoodsCatMemListResp">
        select p.name, p.price, b.name sale_cat_name, p.state, ts.store_name,
        <include refid="prod_goods_cat_mem_column"/>
        from tbl_prod_goods_cat_mem a
        join tbl_prod_goods p on p.goods_id = a.goods_id
        join tbl_prod_goods_cat b on a.cat_id = b.cat_id
        join tbl_store ts on ts.store_id = p.store_id
        where p.state != 'X'
        and a.state = 'A'
        and b.state = 'A'
        and a.cat_id = #{catId}
        order by a.goods_id
    </select>

    <!--<select id="qryGoodsCatMemList" resultType="com.iwhalecloud.retail.offer.dto.resp.QryGoodsCatMemListResp">-->
        <!--select f.cat_id sale_cat_id, f.name sale_cat_name, a.cat_mem_id, c.cat_id, b.goods_id, b.buy_count,-->
               <!--b.is_recommend, ts.store_id, ts.store_name,b.name, b.sn,  b.type_id, g.type_name, b.state,-->
               <!--b.stock_qty, b.mktprice, b.price, b.marketing_begin_time, b.marketing_end_time-->
          <!--from prod_goods b-->
        <!--left join (select d.goods_id, d.cat_id, e.name, e.cat_type-->
                     <!--from prod_goods_cat_mem d, prod_goods_cat e-->
                    <!--where d.cat_id = e.cat_id-->
                      <!--and e.cat_type = 'S') f-->
               <!--on b.goods_id = f.goods_id,prod_goods_cat_mem a, prod_goods_cat c,prod_goods_type g, tbl_store ts-->
        <!--where b.goods_id = a.goods_id-->
        <!--and b.store_id = ts.store_id-->
        <!--and a.cat_id = c.cat_id-->
        <!--and (c.active_flag is null or c.active_flag != 'Y')-->
        <!--and b.type_id = g.type_id-->
        <!--and b.state <![CDATA[<>]]> 'X'-->
        <!--<if test="request.catId != null and request.catId.length() >0 ">-->
            <!--and c.cat_id = #{request.catId}-->
        <!--</if>-->
        <!--<if test="request.catType != null and request.catType.length() >0 ">-->
            <!--and c.cat_type = #{request.catType}-->
        <!--</if>-->
        <!--<if test="request.name != null and request.name.length() >0 ">-->
            <!--and lower(b.name) like lower(concat(concat('%', #{request.name}), '%'))-->
        <!--</if>-->
        <!--<if test="request.marketingBeginTime != null">-->
            <!--<![CDATA[and b.marketing_begin_time >= #{request.marketingBeginTime}]]>-->
        <!--</if>-->
        <!--<if test="request.marketingEndTime != null">-->
            <!--<![CDATA[and b.marketing_end_time < #{request.marketingEndTime}]]>-->
        <!--</if>-->
        <!--<if test="request.storeId != null and request.storeId.length() >0 ">-->
            <!--and b.store_id = #{request.storeId}-->
        <!--</if>-->
        <!--<if test="request.sn != null and request.sn.length() >0 ">-->
            <!--and b.sn = #{request.sn}-->
        <!--</if>-->
        <!--<if test="request.typeId != null and request.typeId.length() >0 ">-->
            <!--and b.type_id = #{request.typeId}-->
        <!--</if>-->
        <!--<if test="request.state != null and request.state.length() >0 ">-->
            <!--and b.state = #{request.state}-->
        <!--</if>-->
        <!--order by b.created_date desc-->
    <!--</select>-->

    <select id="qryGoodsCatMemList" resultType="com.iwhalecloud.retail.offer.dto.resp.QryGoodsCatMemListResp">
       select a.cat_mem_id,
              g.type_name,
              ts.store_id, ts.store_name, ts.state as store_state,
              c.cat_id, c.cat_id as saleCatIid, c.name as saleCatName,
              b.state, b.stock_qty, b.mktprice, b.price, b.marketing_begin_time, b.marketing_end_time,
              b.name, b.sn, b.type_id, b.goods_id, b.buy_count, b.is_recommend
         from tbl_prod_goods b
    left join tbl_prod_goods_type g on g.type_id = b.type_id
    left join tbl_store ts on ts.store_id = b.store_id
    left join tbl_prod_goods_cat_mem a on a.goods_id = b.goods_id
    left join tbl_prod_goods_cat c on c.cat_id = a.cat_id
        where b.state != 'X'
          and a.state = 'A'
          and c.state = 'A'
          and g.state = 'A'
          and c.cat_type = 'S'
          and (c.active_flag is null or c.active_flag != 'Y')
        <if test="request.catId != null and request.catId != ''">
            and c.cat_id = #{request.catId}
        </if>
        <if test="request.catType != null and request.catType != ''">
            and c.cat_type = #{request.catType}
        </if>
        <if test="request.name != null and request.name != ''">
            and lower(b.name) like lower(concat(concat('%', #{request.name}), '%'))
        </if>
        <if test="request.marketingBeginTime != null">
            <![CDATA[and b.marketing_begin_time >= #{request.marketingBeginTime}]]>
        </if>
        <if test="request.marketingEndTime != null">
            <![CDATA[and b.marketing_end_time < #{request.marketingEndTime}]]>
        </if>
        <if test="request.storeId != null and request.storeId != ''">
            and b.store_id = #{request.storeId}
        </if>
        <if test="request.sn != null and request.sn != ''">
            and b.sn = #{request.sn}
        </if>
        <if test="request.typeId != null and request.typeId != ''">
            and b.type_id = #{request.typeId}
        </if>
        <if test="request.state != null and request.state != ''">
            and b.state = #{request.state}
        </if>
        order by b.create_time desc
    </select>

    <select id="listProdGoodsCatByGoodsId" resultType="com.iwhalecloud.retail.offer.dto.resp.ProdGoodsCatMemResp">
        select b.*, a.cat_mem_id, a.goods_id
          from tbl_prod_goods_cat_mem a
          join tbl_prod_goods_cat b on b.cat_id = a.cat_id
         where a.state = 'A'
         and b.state = 'A'
         and a.goods_id = #{goodsId}
      order by b.cat_id
    </select>
    
    <select id="qryPublishMem" resultType="Long">
        select count(*)
        from tbl_prod_goods_cat_mem cm
        right join tbl_prod_goods pg
        on cm.goods_id = pg.goods_id
        where 1 = 1
        and cm.state = 'A'
        and pg.state = 'C'
        and pg.goods_id in
        <foreach collection="goodsIds" item="goodsId" index="index" open="(" close=")" separator=",">
            #{goodsId}
        </foreach>  
    </select>

    <update id="batchDeleteGoodsMem">
        update tbl_prod_goods_cat_mem
        set state = 'X', modify_time = now(), modify_by = #{modifyBy}
        where 1 = 1
        and state = 'A'
        and goods_id in
        <foreach collection="goodsIds" item="goodsId" index="index" open="(" close=")" separator=",">
            #{goodsId}
        </foreach>
        
    </update>

    <select id="countProGoodsByCatId" resultType="java.lang.Integer">
        select count(1)
          from tbl_prod_goods_cat_mem a
          join tbl_prod_goods b on b.goods_id = a.goods_id
         where b.state != 'X'
           and a.state = 'A'
           and a.cat_id = #{catId}
    </select>

    <select id="qryGoodsIdByCatId" resultType="java.lang.String">
        select goods_id
          from tbl_prod_goods_cat_mem
         where cat_id = #{catId}
         and state = 'A'
    </select>

    <update id="deleteCatMemById">
        update tbl_prod_goods_cat_mem
        set state = 'X', modify_time = now(), modify_by = #{modifyBy}
        where cat_id = #{catId}
    </update>

</mapper>