<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.iwhalecloud.retail.offer.mapper.StoreMapper">

    <select id="queryStore" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreResp">
        select ts.*
        from tbl_store ts
        where ts.state != 'X'
        order by ts.create_time desc
    </select>

    <select id="queryStorePage" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreResp">
        select ts.*, ts.tenant_id
          from tbl_store ts
         where 1 = 1
        <if test="req.storeName != null and req.storeName != ''">
           and lower(ts.store_name) like lower(concat(concat('%', #{req.storeName}), '%'))
        </if>
        <if test="req.storeLevelId != null and req.storeLevelId != ''">
           and ts.store_level_id = #{req.storeLevelId}
        </if>
        <if test="req.tenantId != null and req.tenantId != ''">
           and ts.tenant_id = #{req.tenantId}
        </if>
        <if test="req.startDate != null">
            and ts.create_time <![CDATA[ >= ]]> #{req.startDate}
        </if>
        <if test="req.endDate != null">
            and ts.create_time <![CDATA[ <= ]]> #{req.endDate}
        </if>
        <if test="req.state != null and req.state != ''">
            and ts.state = #{req.state}
        </if>
        order by ts.create_time desc
    </select>

    <select id="qryStoreByCond" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreResp">
        select * from tbl_store ts
         where 1 = 1
         <if test="req.storeIds != null and req.storeIds.size() > 0">
              and ts.store_id in
             <foreach collection="req.storeIds" item="item" index="index" open="(" close=")" separator=",">
                 #{item}
             </foreach>
         </if>
         <if test="req.tenantId != null and req.tenantId != ''">
             and ts.tenant_id = #{req.tenantId}
         </if>
        <if test="req.states != null and req.states.size() > 0">
            and ts.state in
            <foreach collection="req.states" item="item" index="index" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="queryStoreDetail" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreDetailResp">
        select ts.*
          from tbl_store ts
         where ts.store_id = #{storeId}
    </select>

    <select id="queryStoreByStoreName" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreResp">
        select *
          from tbl_store
         where store_name = #{storeName}
         and state != 'X'
    </select>

    <select id="countParentStoreById" resultType="java.lang.Integer">
        select count(*)
          from tbl_store
         where state != 'E'
           and parent_store_id = #{storeId}
    </select>

    <select id="qryStoreByOrgId" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreByOrgIdResp">
        select store_id, store_name, state
          from tbl_store
         where org_id = #{orgId}
           and state != 'E'
    </select>

    <select id="queryOrgIdByStoreId" resultType="java.lang.String">
        select org_id
          from tbl_store
         where store_id = #{storeId}
    </select>

    <select id="queryStoreDetailByOrgId" resultType="com.iwhalecloud.retail.offer.dto.resp.QueryStoreDetailResp">
        select *
          from tbl_store
         where org_id = #{orgId}
         and state != 'X'
    </select>

    <update id="updateStoreByCreditScore">
        update tbl_store
           set credit_score = #{creditScore}
         where store_id = #{storeId}
    </update>

    <update id="updateCreditScoreByRateAndStoreId">
        update tbl_store
        <set>
            <if test="rate != null and rate == '5'.toString()">
                credit_score = credit_score + 1,
            </if>
            <if test="rate != null and rate == '1'.toString()">
                credit_score = credit_score - 1,
            </if>
            modify_time = now()
        </set>
          where store_id = #{storeId}
    </update>

</mapper>