<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.iwhalecloud.retail.offer.mapper.ProdGoodsCatAttrValueMapper">


    <select id="qryProdGoodsCatAttrList" resultType="com.iwhalecloud.retail.offer.dto.resp.GoodsCatAttrResp">
        select a.attr_id, a.priority, a.attr_value, a.create_by, a.create_time, a.modify_by,
        a.modify_time, b.attr_name, a.inherited_flag, b.attr_code, b.attr_type, b.input_type, b.nullable, b.comments, b.private_type, b.private_obj_id
        from tbl_prod_goods_cat_attr_value a
        join tbl_attr b on a.attr_id = b.attr_id
        where a.state = 'A'
        and a.cat_id = #{request.catId}
        and b.state != 'X'
        <if test="request.qt != null and request.qt.length() >0 ">
            <bind name="pattern" value="'%' + request.qt + '%'" />
            and (b.attr_name like #{pattern} or b.attr_code like #{pattern})
        </if>
        order by a.priority desc
    </select>


    <select id="qrySkuGoodsCatAttrByCatId" resultType="com.iwhalecloud.retail.offer.dto.resp.GoodsCatAttrResp">
        select a.attr_id, a.priority, a.attr_value, a.create_by, a.create_time, a.modify_by,
               a.modify_time, a.inherited_flag, b.attr_name, b.attr_code, b.attr_type, b.input_type, b.nullable,
               b.comments, b.private_type, b.private_obj_id
          from tbl_prod_goods_cat_attr_value a
          join tbl_attr b on a.attr_id = b.attr_id
         where a.state = 'A'
           and a.cat_id = #{catId}
           and b.state != 'X'
         order by a.priority desc
    </select>


    <select id="qryOutAttrListByCatId" resultType="com.iwhalecloud.retail.offer.dto.resp.GoodsCatAttrResp">
        select a.attr_id, a.priority, a.create_by, a.create_time, a.modify_by,
        a.modify_time, a.attr_name, a.attr_code, a.attr_type, a.input_type, a.nullable, a.comments, a.private_type, a.private_obj_id
        from tbl_attr a
        where (a.private_type = '2' and a.private_obj_id = #{request.catId}) and a.state != 'X'
        <if test="request.qt != null and request.qt.length() >0 ">
            <bind name="pattern" value="'%' + request.qt + '%'" />
            and (a.attr_name like #{pattern} or a.attr_code like #{pattern})
        </if>
        and a.attr_id not in (
        select t.attr_id from tbl_prod_goods_cat_attr_value t where t.state = 'A' and t.cat_id = #{request.catId}
        )
        union all
        select a.attr_id, a.priority, a.create_by, a.create_time, a.modify_by,
        a.modify_time, a.attr_name, a.attr_code, a.attr_type, a.input_type, a.nullable, a.comments, a.private_type, a.private_obj_id
        from tbl_attr a
        where 1=1 and (a.private_type is null or a.private_type = '') and a.state != 'X'
        <if test="request.qt != null and request.qt.length() >0 ">
            <bind name="requestQt" value="'%' + request.qt + '%'" />
            and (a.attr_name like #{requestQt} or a.attr_code like #{requestQt})
        </if>
        and a.attr_id not in (
        select t.attr_id from tbl_prod_goods_cat_attr_value t where t.state = 'A' and t.cat_id = #{request.catId}
        )
    </select>
    
    <select id="qryCatAttrById" resultType="com.iwhalecloud.retail.offer.entity.ProdGoodsCatAttrValue">
        select * from tbl_prod_goods_cat_attr_value
        where 1 = 1
        and state = 'A'
        <if test="catId != null and catId != ''">
            and cat_id = #{catId}
        </if>
    </select>

    <delete id="deleteCatAttrListByCatId">
        update tbl_prod_goods_cat_attr_value
        set state = 'X', modify_time = now(), modify_by = #{modifyBy}
        where cat_id = #{catId}
    </delete>

    <insert id="insertCatAttr">
        insert into tbl_prod_goods_cat_attr_value(cat_attr_value_id, cat_id, attr_id, attr_value, priority, create_by, create_time, modify_by, modify_time, inherited_flag, state)
         values (#{catAttrValueId}, #{catId}, #{attrId}, #{attrValue}, #{priority}, #{createBy}, #{createTime}, #{modifyBy}, #{modifyTime}, #{inheritedFlag}, #{state})
    </insert>
</mapper>